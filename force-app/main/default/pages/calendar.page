<apex:page standardStylesheets="false" showHeader="false" sidebar="false" controller="CalendarCtrl" title="{!$Label.cc_qappt__calender} -{!$Label.cc_qappt__quick_appointment}" id="pge">
<c:NewHeader />
  <style> 
  body  {
  display:none;
  } 
 
  </style>
 <script>
window.addEventListener("DOMContentLoaded", function(){
  document.getElementsByTagName("body")[0].style.display = "block";
});
</script>

<apex:form id="frm"> 
<link rel="stylesheet" href="{!URLFOR($Resource.calender,'calender/fullcalendar.css')}" />
<link rel="stylesheet" href="{!URLFOR($Resource.calender,'calender/fullcalendar.print.css')}" media='print'/>
<script src="{!URLFOR($Resource.calender,'calender/moment.js')}"></script>
<script src="{!URLFOR($Resource.calender,'calender/fullcalendar.min.js')}"></script>

<script src="{!URLFOR($Resource.datepicker,'datepicker/bootstrap-datepicker.min.js')}" type="text/javascript"></script>

 <script src="{!URLFOR($Resource.datepicker,'datepicker/timepicki.js')}" type="text/javascript"></script> 
<link href="{!URLFOR($Resource.datepicker,'datepicker/datepicker.min.css')}" rel="stylesheet"/>
<link href="{!URLFOR($Resource.datepicker,'datepicker/datepicker3.min.css')}" rel="stylesheet"/>
<style>
.fc .fc-button-group > * {
    float: left;
    margin: 0 0 0 13px;
  }
</style>
<script>
 
    var currentTimezone = '{!JSENCODE(selectedTimeZone)}';
    var appevents = new Array();
   
    $(document).ready(function() { 
        var selecteddates =  document.querySelectorAll(".fc-past");
        for (var i = 0; i < selecteddates.length; ++i) {
            selecteddates[i].classList.add('cf');
        }

        fetchAppointmentsJSON();   
     $('#datePicker').datepicker({ format: 'dd/mm/yyyy'});
    });
    
    
    function fetchAppointmentsJSON(){
        $('#status').css('display','block');
        $('#calendar').fullCalendar( 'refresh' );        
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.CalendarCtrl.fetchAllAppointmentSlotsJSON}',
            currentTimezone,
            function(result, event) 
            {       
                var apps = '';
                apps = result.replace(/&(lt|gt|quot);/g, function (m, p) { 
                    return (p == "lt") ? "<" : ((p == "gt") ? ">" : "\"");
                });  
                appevents = jQuery.parseJSON(apps);
                console.log(appevents);
                //alert(JSON.stringify(appevents));
                refreshCalendar();            
            }            
        );      
    }
    
    function changeTimezone(){        
        currentTimezone = $("#pge\\:frm\\:timezone-selector option:selected").val();         
        fetchAppointmentsJSON();
    }
    
    function refreshCalendar(){   
                  
        $('#calendar').fullCalendar( 'destroy' );
        
        $('#calendar').fullCalendar({ 
            header: {
                left: 'prev,next today',
                center: 'title',
                right: 'month,agendaWeek,agendaDay'
            },
            
            editable: false,
            eventLimit: true,
            events: appevents,
            timeFormat: 'HH(:mm) a', 
         
          eventAfterAllRender: function(view){
            if(view.name == 'month')
            {                       
                $('.fc-day.fc-future').each(function(){
                    $(this).css('position','relative');
                    $(this).append('<a class="add_event_label" `enter code here`style="position:absolute;bottom:0;left:0;right:0;display: block;border-top:1px solid black;font-size:12px;color:#000;text-align:center;cursor:pointer;">(+)Appointment</a>');
                });  
                $('.fc-day.fc-today').each(function(){
                    $(this).css('position','relative');
                    $(this).append('<a class="add_event_label" `enter code here`style="position:absolute;bottom:0;left:0;right:0;display: block;border-top:1px solid black;font-size:12px;color:#000;text-align:center;cursor:pointer;">(+)Appointment</a>');
                });      
      
            }                   
        },
                   
                   
            eventRender: function(event, element) {
              var selecteddates =  document.querySelectorAll(".fc-past");
                    for (var i = 0; i < selecteddates.length; ++i) {
                        selecteddates[i].classList.add('cf');
                    }
               element.css('background-color',event.eventColor);    
                         
            },
  
            
            dayClick: function(date, jsEvent, view) {
            if (moment().format('YYYY-MM-DD') === date.format('YYYY-MM-DD') || date.isAfter(moment())) {
                $('[id$=ClickDateTime]').text(date.format().replace('T' , ' '));
                if(view.name == 'month'){
                    AppointmmentPopUp();
                }
                if(view.name == 'agendaDay' || view.name == 'agendaWeek'){
                    AppointmentPopUpDayView();
                }
               // This allows today and future date
                } else {
                      var selecteddates =  document.querySelectorAll(".fc-past");
                    for (var i = 0; i < selecteddates.length; ++i) {
                        selecteddates[i].classList.add('cf');
                    }
                }
            
   
                       
               
        }, 
            eventClick : function(calEvent,event) {                 
              var appId = calEvent.id;
              $('[id$=myAppointmentUpdate]').modal('show');
              $('#appUpdates').html('<iframe src="/apex/Appointment?id='+appId+'" width="100%" height="540" frameborder="0"></iframe>');              
            }, 
            eventMouseover: function(calEvent,jsEvent) {
                 console.log("Hello",calEvent);
                 $("#pop-up").css('background', calEvent.eventColor);
                $('#popOverData').html('<label>'+calEvent.Name+'</label>' +'<br/>'+ '<label>'+calEvent.Description+'</label>'+'<br/>'+ '<label>'+calEvent.Status+'</label>'+'<br/>'+'<label>'+calEvent.Capacity+'</label>'+'<br/>'+'<label>Start DateTime = </label><label>'+calEvent.start.format('MMMM Do YYYY h:mm a')+'</label>'+'<br/>'+ '<label>End DateTime = </label><label>'+calEvent.end.format('MMMM Do YYYY h:mm a')+'</label>');
                $('.fc-event-container').hover(function(e) {
                  $('#pop-up').show();
                  $('#popOverData').html('<label>'+calEvent.Name+'</label>' +'<br/>'+ '<label>'+calEvent.Description+'</label>'+'<br/>'+ '<label>'+calEvent.Status+'</label>'+'<br/>'+'<label>'+calEvent.Capacity+'</label>'+'<br/>'+'<label>Start DateTime = </label><label>'+calEvent.start.format('MMMM Do YYYY h:mm a')+'</label>'+'<br/>'+ '<label>End DateTime = </label><label>'+calEvent.end.format('MMMM Do YYYY h:mm a')+'</label>');
                }, function() {
                  $('#pop-up').hide();
                });
            },
            eventMouseout: function(calEvent,jsEvent) {
                var moveLeft = 20;
                var moveDown = 10;        
                $('.fc-event-container').mousemove(function(e) {
                  $("#pop-up").css('top', e.pageY + moveDown).css('left', e.pageX + moveLeft);
                });
            }                       
        });  
        
        $('#status').css('display','none');
        $('.fc-left').append('<button type="button" class="fc-button fc-state-default fc-corner-left" onclick="AppointmmentPopUpButton(); return false;">{!$Label.Add_Appointment}</button>');
        $('.fc-right').append('<button type="button" class="fc-button fc-state-default fc-corner-left" onclick="AppointmmentAgenda(); return false;">{!$Label.Agenda}</button>');
        
        $('.fc-prev-button').click(function(){
        var selecteddates =  document.querySelectorAll(".fc-past");
        for (var i = 0; i < selecteddates.length; ++i) {
            selecteddates[i].classList.add('cf');
        }

      });
        $('.fc-next-button').click(function(){
          var tglCurrent = $('#calendar').fullCalendar('getDate');
                var date = new Date(tglCurrent);
                var year = date.getYear();
                var month = date.getMonth();
                   var selecteddates =  document.querySelectorAll(".fc-past");
                    for (var i = 0; i < selecteddates.length; ++i) {
                        selecteddates[i].classList.add('cf');
                    }
        });


    } 
    
    function AppointmmentPopUp(){
       var datetime = $('#ClickDateTime').text().split(" ");
      
       var date =  datetime[0].split("-");
        var newDate = date[0]+ "-" +date[1]+ "-" +date[2];
        
        $('[id$=myAppointment]').modal('show');  
        //$('[id$=myModal]').modal('hide');
        $('#app').html('<iframe src="/apex/Appointment?date='+newDate+'" width="100%" height="540" frameborder="0"></iframe>');  
    }
    
    function AppointmentPopUpDayView(){
       var datetime = $('#ClickDateTime').text().split(" ");
      
       var date =  datetime[0].split("-");
        var newDate = date[0]+ "-" +date[1]+ "-" +date[2];
        
        $('[id$=myAppointment]').modal('show');  
        $('#app').html('<iframe src="/apex/Appointment?date='+newDate+' &time= '+datetime[1]+'" width="100%" height="540" frameborder="0"></iframe>');  
    }
    
    function AppointmmentPopUpButton(){
       
        $('[id$=myAppointment]').modal('show');  
        $('[id$=myModal]').modal('hide');
        $('#app').html('<iframe src="/apex/Appointment" width="100%" height="540" frameborder="0"></iframe>');  
    }
    
    function BusyTimePopUp(){
        $('[id$=BusyTime]').modal('show');
        $('[id$=myModal]').modal('hide');
    }
    
    function AppointmmentAgenda(){
        $(".content").hide();   
        $('[id$=myAgenda]').modal('show');
        $(".heading").click(function()
        {
        if($(this).next('.content:visible').length){
        $(this).next(".content").hide();
        }
        else{
        $(this).next(".content").show();
        }
      });
    }
    function showDayView(start){
        $('[id$=myAgenda]').modal('hide');
        var parts = start.split('/');
        var mydate = parts[2] + "/" + parts[1] + "/" + parts[0];
        $('#calendar').fullCalendar('gotoDate', mydate);
        $('#calendar').fullCalendar('changeView', 'agendaDay'); 
        $('.fc-right').append('<button type="button" class="fc-button fc-state-default fc-corner-left" onclick="printPreview(); return false;">Print</button>');
    }
    
    function printPreview() {
         window.print();
    }
 
</script>
<script type="text/javascript">
    jQuery(document).ready(function() {
      jQuery(".content").hide();
      //toggle the componenet with class msg_body
      jQuery(".heading").click(function()
      {
        jQuery(this).next(".content").slideToggle(500);
      });
    });
</script>

<style media='print'>
#hoe-left-panel, .hoe-right-header, .hoe-left-header{ display:none}
@page {size: landscape}

</style>

<style>
    .cf{
    border: 1px solid #999999;
    background-color: #cccccc;
    color: #666666; 
    }  
    .layer1 {
    margin: 0;
    padding: 0;
    width: 100%;
    }
    
    .heading {
    margin: 1px;
    color: #fff;
    padding: 3px 10px;
    cursor: pointer;
    position: relative;
    background-color:#578ebe;;
    }
    .content {
    padding: 5px 10px;
    background-color:#fafafa;
    }
    p { padding: 5px 0; }
    
    .datepicker.datepicker-dropdown{
        z-index:9999 ! important;
    }
</style>

<style>
    #pop-up {
        display: none;
        position: absolute;
        width: 280px;
        padding: 10px;
        /*background: blue;*/
        color: white;
        /*border: 1px solid #1a1a1a;*/
        font-size: 90%;
        z-index: 1000;
        border-radius: 10px;
      }
</style>
<apex:actionFunction name="searchAgendaAppointment" action="{!searchAgenda}" reRender="showAgendaApp"/>
<apex:actionFunction name="handleCloseHandle"  action="{!closeAgenda}" reRender="showAgendaApp"/>
<!-- Menu Code Start--->
<body hoe-navigation-type="vertical" hoe-nav-placement="left" id="navTypeAndPlacement">
    <div id="hoeapp-wrapper" class="hoe-hide-lpanel" hoe-device-type="desktop">
        <c:HeaderNested />
        <div id="hoeapp-container" hoe-color-type="lpanel-bg2" hoe-lpanel-effect="shrink">
            <c:SideBar />
            <section id="main-content">
                <!-- Menu Code End --->
                 
                  <!--  <div id="status" style="display:none;"> 
                        fetching....
                    </div>
                    <apex:selectList onchange="changeTimezone();" id="timezone-selector" value="{!selectedTimeZone}" multiselect="false" size="1">
                        <apex:selectOptions value="{!allTimeZones}"/>
                    </apex:selectList>    -->    
                    <div id="calendar"></div>
                    
               
                <!-- main code of Calender end -->
            </section>
        </div>
    </div> 
    
    
<!-- -->
<div class="modal fade bs-example-modal-sm" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-sm">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="myModalLabel"><div id="ClickDateTime"></div></h4>
              </div>
              <div class="modal-body">
                  <div class="list-group">
                      <a class="list-group-item" href="#" onclick="AppointmmentPopUp();return false;"><i class="fa fa-plus fa-fw"></i>&nbsp; {!$Label.Add_Appointment}</a>
                     <!-- <a class="list-group-item" href="#" onclick="BusyTimePopUp();return false;"><i class="fa fa-clock-o fa-fw"></i>&nbsp; {!$Label.Add_Busy_Time}</a>
                       <a class="list-group-item" href="#"><i class="fa fa-pencil fa-fw"></i>&nbsp; {!$Label.Delete_Appointment}</a>
                      <a class="list-group-item" href="#"><i class="fa fa-cog fa-fw"></i>&nbsp; {!$Label.Settings}</a> -->
                </div>

              </div>
            </div>
          </div>
        </div>
<!-- for new appointment --> 

<div class="modal fade bs-example-modal-lg" id="myAppointment" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel">{!$Label.Appointment_Details}</h4>
      </div>
      <div class="modal-body" id="app">
          

       </div>
            </div>
          </div>
        </div>
 
<!-- appointment update -->       
<div class="modal fade bs-example-modal-lg" id="myAppointmentUpdate" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel">{!$Label.Appointment_Details}</h4>
      </div>
      <div class="modal-body" id="appUpdates">
          

       </div>
            </div>
          </div>
        </div>       
     


<!-- appointment popOver -->
<div id="pop-up">
<div id="popOverData">
</div>
</div>

<!-- add busy time -->

<div class="modal fade bs-example-modal-sm" id="BusyTime" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-sm">
            <div class="modal-content">
              <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="myModalLabel">Busy Time</h4>
              </div>
              <div class="modal-body">
                  <div class="row">
                        <div class="col-md-6">
                            <label>Start Date Time</label>
                            <apex:inputField value="{!Appointment.Start_Date_Time__c}" styleClass="form-control"/>
                        </div>
                        <div class="col-md-6">
                            <label>End Date Time</label>
                            <apex:inputField value="{!Appointment.End_Date_Time__c}" styleClass="form-control"/>
                        </div>
                    </div>
                    <div class="row">
                    <div class="col-md-12">
                            <apex:commandButton styleclass="btn btn-default" value="{!$Label.cc_qappt__save}" action="{!saveBusyTime}"/>
                            <button class="btn btn-default" onclick="CancelNewAppointment();return false;">{!$Label.Cancel}</button>
                         </div>
                    </div>
            
              </div>
          </div>
      </div>
  </div>
  
  
<div class="modal fade bs-example-modal-lg" id="myAgenda" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" onclick="handleCloseAgenda();" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title" id="myModalLabel">{!$Label.Appointment_Details}</h4>
      </div>
      <div class="modal-body" id="appAgenda">
      <div class="row">
          <div class="col-md-12">
          <label>Search By Date</label>
            <div class="input-group input-append date" id="datePicker">
                  <apex:inputText id="startDateInput" value="{!startDate}" styleClass="form-control"  onchange="searchAgendaAppointment(); return false;"/> 
                  <span class="input-group-addon add-on"><i class="fa fa-calendar"></i></span>
              </div>
          </div>
          
       </div>
            <apex:outputPanel id="showAgendaApp">
            <apex:outputPanel rendered="{!!hasbooking}">                     
              <apex:repeat value="{!DateAppointmentMap}" var="app"> 
                <div class="layer1">                  
                    <p class="heading"> {!app}</p>
                    <div class="content">
                    <table>
                        
                    <tr>
                        <td>
                            <!--<a href="" onclick="showDayView('{!JSENCODE($CurrentPage.parameters.app)}'); return false;" style="float:top;">View</a>-->
                            <apex:outputLink value="javascript:showDayView('{!app}');" style="float:top;">View</apex:outputLink>
                        </td>
                    <td>&nbsp;&nbsp;</td>
                    <td>
                        <table>
                            <apex:repeat value="{!DateAppointmentMap[app]}" var="applst">
                                <tr><td>{!applst.name}</td></tr> 
                            </apex:repeat>
                        </table>
                    </td>
                    </tr>
                    </table>
                    </div>
                </div>
            </apex:repeat>  
            </apex:outputPanel>
            <apex:outputPanel rendered="{!hasbooking}">
                 <p>There is no appointment</p>
            </apex:outputPanel>
            </apex:outputPanel> 
      </div>
            </div>
          </div>
        </div>
  <script>
  $('#datePicker input').click(function(event){
   $('#datePicker').data("DateTimePicker").show();
});
/*  $('#startDateInput').focus(function(event){
    event.preventDefault();
    $('#datePicker').datepicker({});
});      
  */      
/*function openDatePicker(event){
 
  $(".datepicker.datepicker-dropdown").css("display","none");
    
    $("#datePicker").datepicker({ format: 'dd/mm/yyyy'});

}*/
function handleCloseAgenda(){
    handleCloseHandle();
    document.getElementById('startDateInput').value="";
    $(".content").hide();   
   // alert('close');

}
</script>
        
  
</body> 
</apex:form>      
</apex:page>